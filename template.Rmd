---
title: "Super Awesome Project Template"
output: word_document
names: "Caleb Bekkum, Luke Spika, Cole Umland, Charlie Wiegel"
date: "2025-04-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Section One
Genius API info 
Client ID: r8BXdSiDmw9qfMoxh2S3f1g4AtvDaPf8XD-TWjkO77sc_hvsglOutM9Pl67I67Tr
Client Secret : pvEdzTUfKqtLbjv0qdxBJrqs5Hj1JQlhf4ICcQPWp3Zfo5j7uO88_34UWDbmT5a38wZP9lrTksDX4r8csgZsVA
Client Access Token: BoaVCPyQtW90wUPpm3lPVgm1b5AJGB0BIBvG1UO9dj473mlajOuyvJ1hrN0Dvw9G
Nickname : Luke5pika

```{r}

# This code chunk is for setting up access and web-scraping song info from the Spotify API

library(httr)
library(jsonlite)
library(rvest)

# Genius API Token
genius_token <- "BoaVCPyQtW90wUPpm3lPVgm1b5AJGB0BIBvG1UO9dj473mlajOuyvJ1hrN0Dvw9G" 
# Test song
test_title <- "Blinding Lights"
test_artist <- "The Weeknd"

# Function to search Genius for lyrics of given songs
# inputs: title of song, artist of song, and a given Genius token
# outputs: A url to the Genius page containing the lyrics of the song, as well as the lyrics themselves
search_song <- function(title, artist, token) {
  query <- URLencode(paste(title, artist))
  url <- paste0("https://api.genius.com/search?q=", query)
  res <- GET(url, add_headers(Authorization = paste("Bearer", token)))

  if (status_code(res) == 200) {
    json <- fromJSON(content(res, as = "text"), simplifyVector = FALSE)
    hits <- json$response$hits

    for (hit in hits) {
      result <- hit[["result"]]
      if (!is.null(result)) {
        primary_artist <- result[["primary_artist"]]
        artist_name <- primary_artist[["name"]]

        if (!is.null(artist_name) && grepl(tolower(artist), tolower(artist_name))) {
          return(result[["url"]])
        }
      }
    }
  } else {
    warning("API request failed with status code: ", status_code(res))
  }

  return(NA)
}

#Function to get lyrics
#Inputs: Genius URL
#Outputs: cleaned up lyrics as one line
get_clean_lyrics <- function(url) {
  page <- read_html(url)
  lyrics_nodes <- html_elements(page, '[data-lyrics-container="true"]')

  if (length(lyrics_nodes) == 0) {
    lyrics_nodes <- html_elements(page, 'div.lyrics')  # fallback
  }

  # Collapse all the lyrics text with line breaks between nodes
  lyrics <- lyrics_nodes %>%
    html_text2() %>%  # html_text2() preserves line breaks better
    paste(collapse = "\n")

  # Keep only content after [Intro] or [Verse 1]
  lyrics_after <- sub(".*\\[(Intro|Verse 1)\\]", "", lyrics, ignore.case = TRUE)

  # Remove all [Section Headers]
  clean_lyrics <- str_replace_all(lyrics_after, "\\[.*?\\]", "")

  # Trim and fix spacing
  clean_lyrics <- gsub("\\s+", " ", clean_lyrics)
  clean_lyrics <- trimws(clean_lyrics)

  return(clean_lyrics)
}



```

## Section Two

```{r Luke Spika}
new project test
```

## Section Three

```{r Cole Umland}
#This table is cleaned up and ready to roll.
library(rvest)
library(dplyr)
library(purrr)
library(stringr)

decade_urls <- c(
  "https://en.wikipedia.org/wiki/List_of_Billboard_Hot_100_number-one_singles_from_1958_to_1969",
  "https://en.wikipedia.org/wiki/List_of_Billboard_Hot_100_number-one_singles_of_the_1970s",
  "https://en.wikipedia.org/wiki/List_of_Billboard_Hot_100_number-one_singles_of_the_1980s",
  "https://en.wikipedia.org/wiki/List_of_Billboard_Hot_100_number-one_singles_of_the_1990s",
  "https://en.wikipedia.org/wiki/List_of_Billboard_Hot_100_number-one_singles_of_the_2000s",
  "https://en.wikipedia.org/wiki/List_of_Billboard_Hot_100_number-one_singles_of_the_2010s",
  "https://en.wikipedia.org/wiki/List_of_Billboard_Hot_100_number-one_singles_of_the_2020s"
)

all_number_ones <- map_df(decade_urls, function(url) {
  page <- read_html(url)

  table <- page %>%
    html_node("table.wikitable") %>%
    html_table(fill = TRUE)

  names(table) <- tolower(names(table))

  if (any(str_detect(names(table), "single|song")) && any(str_detect(names(table), "artist"))) {
    cleaned <- table %>%
      select(contains("single"), contains("artist"), contains("reached")) %>%
      rename_with(~ c("single", "artist", "date")[1:length(.)]) %>%
      # Remove rows with all values that have four characters
      #Clever, ran into the problem where deleting rows with only four characters also deleted songs with years titles (ex: "1999"). Fixed this by changing any to all in the following code line. All rows with years in every column are now deleted
      filter(!apply(., 1, function(row) all(nchar(as.character(row)) == 4)))
    return(cleaned)
  } else {
    return(NULL)
  }
})

```

## Section Four 

```{r Charlie Wiegel}

library(tidyverse)

# --- 3. Batch Processing with Progress Saving ---
process_batch <- function(data, start_row, end_row, token, output_file) {
  results <- list()

  for (i in start_row:end_row) {
    song <- data[i, ]
    cat("Processing [", i, "]:", song$single, "by", song$artist, "\n")

    url <- tryCatch(search_song(song$single, song$artist, token), error = function(e) NA)
    Sys.sleep(0.5)  # Respect API limits

    lyrics <- if (!is.na(url)) tryCatch(get_clean_lyrics(url), error = function(e) NA) else NA
    Sys.sleep(0.5)

    results[[i - start_row + 1]] <- song %>%
      mutate(genius_url = url, lyrics = lyrics)

    # Save after each row (or do batch-save every 10 rows if preferred)
    write_csv(bind_rows(results), output_file, append = file.exists(output_file))
  }

  return(bind_rows(results))
}

# Example usage
# To process the first 50 rows and save results to 'lyrics_output.csv'
output_file <- "lyrics_output.csv"
start_index <- 51
end_index <- 100  # Change this to batch size you want

# Optional: Skip already processed rows
if (file.exists(output_file)) {
  processed <- read_csv(output_file, show_col_types = FALSE)
  start_index <- nrow(processed) + 1
}

if (start_index <= nrow(all_number_ones)) {
  process_batch(all_number_ones, start_index, min(end_index, nrow(all_number_ones)), genius_token, output_file)
} else {
  cat("All songs already processed.\n")
}
```
